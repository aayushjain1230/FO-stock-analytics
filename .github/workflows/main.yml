name: Run Stock Engine

on:
  schedule:
    # Runs every 30 minutes, Monday-Friday (UTC time) during NYSE hours
    - cron: '*/30 13-21 * * 1-5'
  workflow_dispatch:
    # Manual interface for custom actions and watchlist management
    inputs:
      action:
        description: 'Choose Action'
        required: true
        default: 'Run Stocks'
        type: choice
        options:
          - 'Run Stocks'
          - 'Add to Watchlist'
          - 'Remove from Watchlist'
      manual_tickers:
        description: 'Enter Tickers (comma separated, e.g., AAPL, TSLA)'
        required: false
        default: ''

jobs:
  run-analytics:
    runs-on: ubuntu-latest
    
    # Permissions required to push changes back to the repo
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Update Watchlist (if requested)
        if: github.event.inputs.action == 'Add to Watchlist' || github.event.inputs.action == 'Remove from Watchlist'
        run: |
          # Clean commas and extra spaces
          CLEAN_TICKERS=$(echo "${{ github.event.inputs.manual_tickers }}" | tr ',' ' ')
          
          if [ "${{ github.event.inputs.action }}" == "Add to Watchlist" ]; then
            python main.py --add $CLEAN_TICKERS
          elif [ "${{ github.event.inputs.action }}" == "Remove from Watchlist" ]; then
            python main.py --remove $CLEAN_TICKERS
          fi

      - name: Execute Stock Engine
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          MANUAL_TICKERS: ${{ github.event.inputs.manual_tickers }}
        # Runs analysis if manual action is 'Run Stocks' OR if triggered by Schedule OR manual run without specific input
        if: |
          github.event_name == 'schedule' || 
          github.event.inputs.action == 'Run Stocks' || 
          github.event.inputs.action == ''
        run: python main.py --analyze

      - name: Debug - List Files
        if: always()
        run: ls -R

      - name: Upload Trend Charts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: stock-analysis-plots
          path: plots/
          if-no-files-found: warn

      - name: Upload Execution Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: execution-logs
          path: logs/
          if-no-files-found: ignore

      - name: Commit and Push Changes
        if: always()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Force add files that might be in .gitignore but we want to track
          git add -f state/ || true
          git add watchlist.json || true
          git add -f cache/*.json || true
          
          # Only commit if there are actually changes to avoid workflow errors
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update engine state, cache, and watchlist [automated]"
            
            # --- CRITICAL FIX START ---
            # Pull with rebase ensures we don't get the 'non-fast-forward' rejection
            git pull --rebase origin main
            # --- CRITICAL FIX END ---
            
            git push origin main
          fi

      - name: Notify on Failure
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="⚠️ **FO Engine Alert**: The stock scan workflow has failed. Check GitHub Actions for logs." \
          -d parse_mode="Markdown"
