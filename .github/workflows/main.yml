name: Run Stock Engine

on:
  schedule:
    # Runs every 30 minutes, Monday-Friday (UTC time) during NYSE hours
    - cron: '*/30 13-21 * * 1-5'
  workflow_dispatch:
    # Manual interface for custom actions and watchlist management
    inputs:
      action:
        description: 'Choose Action'
        required: true
        default: 'Run Stocks'
        type: choice
        options:
          - 'Run Stocks'
          - 'Add to Watchlist'
          - 'Remove from Watchlist'
      manual_tickers:
        description: 'Enter Tickers (comma separated, e.g., AAPL, TSLA)'
        required: false
        default: ''

jobs:
  run-analytics:
    runs-on: ubuntu-latest
    
    # Permissions required to push state.json and watchlist.json back to your repo
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # Fetch all history so we can push back to the branch
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Update Watchlist (if requested)
        if: github.event.inputs.action == 'Add to Watchlist' || github.event.inputs.action == 'Remove from Watchlist'
        run: |
          # Convert "AAPL, TSLA" into "AAPL TSLA" so argparse reads them correctly
          CLEAN_TICKERS=$(echo "${{ github.event.inputs.manual_tickers }}" | tr ',' ' ')
          
          if [ "${{ github.event.inputs.action }}" == "Add to Watchlist" ]; then
            python main.py --add $CLEAN_TICKERS
          elif [ "${{ github.event.inputs.action }}" == "Remove from Watchlist" ]; then
            python main.py --remove $CLEAN_TICKERS
          fi

      - name: Execute Stock Engine
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          MANUAL_TICKERS: ${{ github.event.inputs.manual_tickers }}
        # Runs analysis if manual action is 'Run Stocks' OR if triggered by Schedule
        if: github.event.inputs.action == 'Run Stocks' || github.event_name == 'schedule'
        run: python main.py --analyze

      - name: Upload Trend Charts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: stock-analysis-plots
          path: plots/

      - name: Commit and Push Changes
        if: always()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Stage the state and the watchlist
          # We use '|| true' to ensure the script doesn't crash if a file is missing
          git add state/state.json || true
          git add watchlist.json || true
          
          # Commit only if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update stock engine state and watchlist [automated]"
            git push origin main
          fi

      - name: Notify on Failure
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="⚠️ **FO Engine Alert**: The stock scan workflow has failed. Please check the GitHub Actions logs." \
          -d parse_mode="Markdown"
